db.getCollection("students").aggregate( [ { $lookup: { from: "currentreservations", localField: "_id", foreignField: "studentBarCode", as: "reservation" } }, { $addFields: { startingBook: { $first: "$reservation" }, endingBook: { $last: "$reservation" } } }, { $replaceWith: { $unsetField: { field: "reservation", input: "$$ROOT" } } }, { $lookup: { from: "booksByBookCopies", localField: "startingBook.bookCopyBarCode", foreignField : "_id", as: "startingBookCopy" } }, { $lookup: { from: "booksByBookCopies", localField: "endingBook.bookCopyBarCode", foreignField: "_id", as: "endingBookCopy" } }, { $project : { teacherName : 1, grade: 1, lastName: 1, firstName: 1, "startingBookCopy.guidedReadingLevel" : 1, "endingBookCopy.guidedReadingLevel" : 1 } } ]);


mongoexport --db=homereadinglibrary --collection="studentStartAndEndBookLevels" --type=csv --fields="teacherName,grade,lastName,firstName,startingBookCopy.0.guidedReadingLevel,endingBookCopy.0.guidedReadingLevel" --out=studentStartAndEndBookLevels.csv "mongodb+srv://homereadinglibrarydev.lzi4z.mongodb.net" --username root